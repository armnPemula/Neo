{% extends "base.html" %}

{% block title %}User Management - NeoC2{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-users-cog"></i> User Management</h1>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Pending User Registrations</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-users-table">
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Active Users</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="active-users-table">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approve User Modal -->
<div class="modal fade" id="approveUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="approve-user-form">
                    <input type="hidden" id="approve-user-id">
                    <div class="mb-3">
                        <label for="user-role" class="form-label">Assign Role</label>
                        <select class="form-select" id="user-role" required>
                            <option value="">Select a role...</option>
                            <option value="admin">Administrator</option>
                            <option value="operator">Operator</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-approve-btn">Approve</button>
            </div>
        </div>
    </div>
</div>

<script>
// Load pending users
function loadPendingUsers() {
    fetch('/users/api/users/pending', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        const table = document.getElementById('pending-users-table');
        if (data.success && data.users.length > 0) {
            table.innerHTML = '';
            data.users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${new Date(user.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-success me-1" onclick="openApproveModal('${user.id}', '${user.username}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="denyUser('${user.id}')">
                            <i class="fas fa-times"></i> Deny
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });
        } else {
            table.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No pending registrations</td></tr>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('pending-users-table').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading pending users</td></tr>';
    });
}

// Load active users
function loadActiveUsers() {
    fetch('/users/api/users/active', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        const table = document.getElementById('active-users-table');
        if (data.success && data.users.length > 0) {
            table.innerHTML = '';
            data.users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="badge bg-${user.role_name === 'admin' ? 'danger' : user.role_name === 'operator' ? 'primary' : 'secondary'}">${user.role_name}</span></td>
                    <td><span class="badge bg-${user.is_active ? 'success' : 'secondary'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                    <td>
                        ${user.role_name !== 'admin' ? `
                        <button class="btn btn-sm btn-warning me-1" onclick="changeUserRole('${user.id}', '${user.username}')">
                            <i class="fas fa-user-tag"></i> Change Role
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deactivateUser('${user.id}', '${user.username}')">
                            <i class="fas fa-user-slash"></i> Deactivate
                        </button>
                        ` : `
                        <span class="text-muted">Administrator</span>
                        `}
                    </td>
                `;
                table.appendChild(row);
            });
        } else {
            table.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No active users</td></tr>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('active-users-table').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading active users</td></tr>';
    });
}

// Open approve modal
function openApproveModal(userId, username) {
    document.getElementById('approve-user-id').value = userId;
    document.getElementById('user-role').value = 'viewer'; // Default role
    new bootstrap.Modal(document.getElementById('approveUserModal')).show();
}

// Confirm approve
document.getElementById('confirm-approve-btn').addEventListener('click', function() {
    const userId = document.getElementById('approve-user-id').value;
    const role = document.getElementById('user-role').value;
    
    if (!role) {
        alert('Please select a role');
        return;
    }
    
    approveUser(userId, role);
});

// Approve user
function approveUser(userId, role) {
    fetch('/users/api/users/approve', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId,
            role: role
        }),
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('User approved successfully');
            bootstrap.Modal.getInstance(document.getElementById('approveUserModal')).hide();
            loadPendingUsers();
            loadActiveUsers();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error approving user');
    });
}

// Deny user
function denyUser(userId) {
    if (confirm('Are you sure you want to deny this user registration?')) {
        fetch('/users/api/users/deny', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User registration denied');
                loadPendingUsers();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error denying user');
        });
    }
}

// Change user role
function changeUserRole(userId, username) {
    const role = prompt(`Change role for ${username} (admin/operator/viewer):`, 'viewer');
    
    if (role && ['admin', 'operator', 'viewer'].includes(role.toLowerCase())) {
        fetch('/users/api/users/change-role', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                role: role.toLowerCase()
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User role changed successfully');
                loadActiveUsers();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error changing user role');
        });
    }
}

// Deactivate user
function deactivateUser(userId, username) {
    if (confirm(`Are you sure you want to deactivate user ${username}?`)) {
        fetch('/users/api/users/deactivate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User deactivated successfully');
                loadActiveUsers();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deactivating user');
        });
    }
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadPendingUsers();
    loadActiveUsers();
});
</script>
{% endblock %}